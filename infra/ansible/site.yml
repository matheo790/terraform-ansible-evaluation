---
- name: TP - deploy app locally (Terraform + Ansible Docker)
  hosts: localhost
  connection: local
  gather_facts: false
  become: false

  vars:
    app_dir: "{{ playbook_dir }}/../../app"
    terraform_dir: "{{ playbook_dir }}/../terraform"
    
    app_env: "prod"
    app_port: 5000
    http_port: 8080

  tasks:
    - name: Ensure Docker and Terraform are available
      ansible.builtin.command: "{{ item }}"
      loop:
        - "docker info"
        - "terraform -version"
      register: check_tools
      changed_when: false

    - name: Build Docker Image for App
      community.docker.docker_image:
        build:
          path: "{{ app_dir }}"
        name: tp-app
        tag: latest
        source: build
      register: build_result
    - name: Terraform Init
      ansible.builtin.command: terraform init -input=false
      args:
        chdir: "{{ terraform_dir }}"
      register: tf_init
      changed_when: "'Terraform has been successfully initialized' in tf_init.stdout"

    - name: Terraform Apply (Infrastructure only)
      ansible.builtin.command: terraform apply -auto-approve -input=false
      args:
        chdir: "{{ terraform_dir }}"
      register: tf_apply
      changed_when: "'Apply complete!' in tf_apply.stdout"

    - name: Deploy App Container (via Ansible)
      community.docker.docker_container:
        name: evaluation_container
        image: tp-app:latest
        networks:
          - name: evaluation_network
        env:
          APP_ENV: "{{ app_env }}"
          PORT: "{{ app_port | string }}"
        state: started
        restart_policy: always

    - name: Deploy Nginx Container (via Ansible)
      community.docker.docker_container:
        name: evaluation_nginx
        image: nginx:latest
        networks:
          - name: evaluation_network
        ports:
          - "{{ http_port }}:80"
        volumes:
          - "{{ terraform_dir }}/nginx.conf:/etc/nginx/conf.d/default.conf:ro"
        state: started
        restart_policy: always

    - name: Post-deploy verification (healthcheck)
      ansible.builtin.uri:
        url: "http://localhost:{{ http_port }}/health"
        method: GET
        status_code: 200
      register: health
      retries: 10
      delay: 3
      until: health.status == 200

    - name: Done
      ansible.builtin.debug:
        msg: "Succ√®s ! L'application est disponible sur http://localhost:{{ http_port }}/health"